generator client {
  provider     = "prisma-client"
  output       = "../generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model OtpCode {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  userId    Int         @map("user_id")
  code      String      @db.VarChar(6)
  type      OtpTypeEnum @default(LOGIN)
  expiresAt DateTime    @map("expires_at") @db.Timestamp(6)
  isUsed    Boolean     @default(false) @map("is_used")
  attempts  Int         @default(0)
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("otp_codes")
}

model UserSession {
  id   String @id @default(cuid())
  uuid String @unique @default(cuid()) @map("uuid")

  userId       Int      @map("user_id")
  refreshToken String   @unique @map("refresh_token") @db.VarChar(500)
  userAgent    String?  @map("user_agent") @db.Text
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  isActive     Boolean  @default(true) @map("is_active")
  expiresAt    DateTime @map("expires_at") @db.Timestamp(6)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("user_sessions")
}

model User {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)
  email     String       @unique @db.VarChar(255)
  role      UserRoleEnum @default(USER)
  isActive  Boolean      @default(true) @map("is_active")
  lastLogin DateTime?    @map("last_login") @db.Timestamp(6)

  otpCodes       OtpCode[]
  sessions       UserSession[]
  teamMembership TeamMember? // 1:1 relationship, each user is a company team member
  invitedMembers TeamMember[]  @relation("TeamMemberInviter")

  @@index([email])
  @@index([role])
  @@map("users")
}

model TeamMember {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  firstName      String  @map("first_name") @db.VarChar(100)
  lastName       String  @map("last_name") @db.VarChar(100)
  position       String? @db.VarChar(100)
  profilePicture String? @map("profile_picture") @db.Text

  role     TeamMemberRoleEnum
  isActive Boolean            @default(true) @map("is_active")

  companyId Int     @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId Int  @unique @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  invitedBy Int?      @map("invited_by")
  inviter   User?     @relation("TeamMemberInviter", fields: [invitedBy], references: [id])
  invitedAt DateTime? @map("invited_at") @db.Timestamp(6)
  joinedAt  DateTime? @map("joined_at") @db.Timestamp(6)

  metadata Json? @db.Json

  @@index([companyId])
  @@index([role])
  @@index([userId])
  @@map("team_members")
}

model Company {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  companyName        String          @map("company_name") @db.VarChar(255)
  registrationNumber String          @unique @map("registration_number") @db.VarChar(100)
  companyType        CompanyTypeEnum @map("company_type")
  taxId              String?         @map("tax_id") @db.VarChar(100)
  notificationEmail  String?         @map("notification_email") @db.VarChar(255)

  country    String  @db.VarChar(100)
  address1   String  @map("address_1") @db.VarChar(255)
  address2   String? @map("address_2") @db.VarChar(255)
  city       String  @db.VarChar(100)
  postalCode String  @map("postal_code") @db.VarChar(20)

  verificationStatus CompanyVerificationStatusEnum @default(PENDING) @map("verification_status")
  isActive           Boolean                       @default(true) @map("is_active")

  metadata Json? @db.Json

  teamMembers  TeamMember[]
  contacts     Employee[]
  groups       EmployeeGroup[]
  payrolls     Payroll[]
  bills        Bill[]
  invoicesFrom Invoice[]       @relation("InvoiceFromCompany") // B2B invoices where this company is the sender
  invoicesTo   Invoice[]       @relation("InvoiceToCompany") // B2B invoices where this company is the recipient

  @@index([registrationNumber])
  @@index([companyName])
  @@index([verificationStatus])
  @@map("companies")
}

model Employee {
  id   Int    @id() @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @map("updated_at") @db.Timestamp(6)

  companyId Int     @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  name          String      @db.VarChar
  walletAddress String      @db.VarChar
  email         String      @db.VarChar
  token         Json        @db.Json
  network       Json        @db.Json
  gender        GenderEnum? @default(PREFER_NOT_TO_SAY) @map("gender")
  nationality   String?     @map("nationality") @db.VarChar(100)
  taxId         String?     @map("tax_id")

  address1   String? @map("address_1") @db.VarChar(255)
  address2   String? @map("address_2") @db.VarChar(255)
  city       String? @db.VarChar(100)
  country    String? @db.VarChar(100)
  postalCode String? @map("postal_code") @db.VarChar(20)

  order   Int           @default(autoincrement())
  groupId Int           @map("groupId")
  group   EmployeeGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  payrolls Payroll[]
  invoices Invoice[] @relation("InvoiceEmployee")

  metadata Json? @db.Json

  @@index([companyId])
  @@index([groupId])
  @@index([email])
  @@map("employees")
}

model EmployeeGroup {
  id   Int    @id() @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @map("updated_at") @db.Timestamp(6)

  name  String            @db.VarChar
  shape CategoryShapeEnum @default(CIRCLE)
  color String            @db.VarChar
  order Int               @default(autoincrement())

  companyId Int     @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  employees Employee[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([order])
  @@map("employee_groups")
}

model Payroll {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  companyId  Int      @map("company_id")
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeId Int      @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  network Json   @db.Json
  token   Json   @db.Json
  amount  String @db.VarChar(50)

  contractTerm ContractTermEnum
  payrollCycle Int               @map("payroll_cycle")
  joiningDate  DateTime          @map("joining_date") @db.Timestamp(6)
  payStartDate DateTime          @map("pay_start_date") @db.Timestamp(6)
  payEndDate   DateTime          @map("pay_end_date") @db.Timestamp(6)
  description  String            @map("description") @db.Text
  status       PayrollStatusEnum @default(ACTIVE)

  note     String? @db.Text
  metadata Json?   @db.Json

  invoices Invoice[]

  @@index([companyId])
  @@index([employeeId])
  @@index([status])
  @@index([payStartDate])
  @@index([payEndDate])
  @@map("payrolls")
}

model Invoice {
  id   Int    @id @default(autoincrement())
  uuid String @unique @default(cuid()) @map("uuid")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  invoiceType InvoiceTypeEnum @default(EMPLOYEE) @map("invoice_type")

  invoiceNumber String   @unique @map("invoice_number") @db.VarChar(50)
  issueDate     DateTime @map("issue_date") @db.Timestamp(6)
  dueDate       DateTime @map("due_date") @db.Timestamp(6)


// Invoice from: Employee or Company
  payrollId  Int?      @map("payroll_id")
  payroll    Payroll?  @relation(fields: [payrollId], references: [id], onDelete: Cascade)
  employeeId Int?      @map("employee_id")
  employee   Employee? @relation("InvoiceEmployee", fields: [employeeId], references: [id], onDelete: Cascade)

  fromCompanyId         Int?     @map("from_company_id")
  fromCompany           Company? @relation("InvoiceFromCompany", fields: [fromCompanyId], references: [id], onDelete: Cascade)


  toCompanyId           Int?     @map("to_company_id")
  toCompany             Company? @relation("InvoiceToCompany", fields: [toCompanyId], references: [id], onDelete: Cascade)
  isToCompanyRegistered Boolean  @default(false) @map("is_to_company_registered")
  toCompanyMetadata Json @db.Json // This is use when toCompany is not registered

  notificationEmails String[] @map("notification_emails") @db.VarChar(255)
 


  fromDetails   Json @db.Json 
  items         Json @db.Json

  // Financial Details
  subtotal  String @db.VarChar(50)
  taxRate   String @db.VarChar(10) // Percentage as string
  taxAmount String @db.VarChar(50)
  total     String @db.VarChar(50)

  // Status and Workflow
  status InvoiceStatusEnum @default(DRAFT)

  // Timeline tracking
  sentAt      DateTime? @map("sent_at") @db.Timestamp(6)
  reviewedAt  DateTime? @map("reviewed_at") @db.Timestamp(6)
  confirmedAt DateTime? @map("confirmed_at") @db.Timestamp(6)

  // Relations
  bill Bill?

  metadata Json? @db.Json
  memo     Json? @db.Json
  footer   Json? @db.Json

  @@index([payrollId])
  @@index([employeeId])
  @@index([fromCompanyId])
  @@index([toCompanyId])
  @@index([invoiceType])
  @@index([status])
  @@index([invoiceNumber])
  @@index([dueDate])
  @@map("invoices")
}

model Bill {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  companyId Int     @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoiceId Int     @unique @map("invoice_id")
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  status BillStatusEnum @default(PENDING)

  paidAt          DateTime? @map("paid_at") @db.Timestamp(6)
  transactionHash String?   @map("transaction_hash") @db.VarChar(100)

  metadata Json? @db.Json

  @@index([companyId])
  @@index([status])
  @@index([invoiceId])
  @@map("bills")
}

model PaymentLink {
  id             Int                   @id() @default(autoincrement())
  code           String                @unique() @map("code") @db.VarChar
  createdAt      DateTime              @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime              @map("updated_at") @db.Timestamp(6)
  title          String                @db.VarChar
  description    String                @db.VarChar
  amount         String                @db.VarChar
  status         PaymentLinkStatusEnum @default(ACTIVE)
  order          Int                   @default(autoincrement())
  payee          String                @db.VarChar
  records        PaymentLinkRecord[]
  acceptedTokens Json?                 @map("accepted_tokens")
  acceptedChains Json?                 @map("accepted_chains")

  @@index([code])
  @@index([payee])
  @@index([order])
  @@map("payment_link")
}

model PaymentLinkRecord {
  id            Int         @id() @default(autoincrement())
  createdAt     DateTime    @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime    @map("updated_at") @db.Timestamp(6)
  payer         String      @db.VarChar
  txid          String?     @map("txid") @db.VarChar
  paymentLinkId Int         @map("payment_link_id")
  PaymentLink   PaymentLink @relation(fields: [paymentLinkId], references: [id])
  token         Json?
  chain         Json?

  @@map("payment_link_record")
}

model Notifications {
  id            Int                     @id() @default(autoincrement())
  createdAt     DateTime                @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime                @default(now()) @map("updated_at") @db.Timestamp(6)
  title         String
  message       String?
  type          NotificationsTypeEnum
  status        NotificationsStatusEnum @default(UNREAD)
  metadata      Json?
  actionUrl     String?                 @map("action_url") @db.VarChar
  walletAddress String                  @map("wallet_address") @db.VarChar
  readAt        DateTime?               @map("read_at") @db.Timestamp(6)

  @@index([status])
  @@index([type])
  @@index([walletAddress])
  @@index([walletAddress, createdAt])
  @@index([walletAddress, status])
  @@map("notifications")
}

enum ContractTermEnum {
  PERMANENT
  CONTRACTOR
}

enum PayrollStatusEnum {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum InvoiceTypeEnum {
  EMPLOYEE // Employee <> Employer invoice (linked to payroll)
  B2B // Business to Business invoice (company <> company)
}

enum InvoiceStatusEnum {
  DRAFT
  SENT
  REVIEWED
  CONFIRMED
  CANCELLED
}

enum BillStatusEnum {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum OtpTypeEnum {
  LOGIN
  EMAIL_VERIFICATION
}

enum CategoryShapeEnum {
  CIRCLE
  DIAMOND
  SQUARE
  TRIANGLE
}

enum NotificationsStatusEnum {
  UNREAD
  READ
}

enum NotificationsTypeEnum {
  NOP
}

enum PaymentLinkStatusEnum {
  ACTIVE
  DEACTIVATED
}

enum CompanyTypeEnum {
  SOLE_PROPRIETORSHIP
  PARTNERSHIP
  LLP
  LLC
  PRIVATE_LIMITED_COMPANY
  CORPORATION
  PUBLIC_LIMITED_COMPANY
  NON_PROFIT
  OTHER
}

enum CompanyVerificationStatusEnum {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
  SUSPENDED
}

enum TeamMemberRoleEnum {
  OWNER
  ADMIN
  VIEWER
}

enum UserRoleEnum {
  USER
  ADMIN
}

enum GenderEnum {
  MALE
  FEMALE
  PREFER_NOT_TO_SAY
  OTHER
}
